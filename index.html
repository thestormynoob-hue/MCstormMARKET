<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>استورم مارکت 💎</title>

  <!-- Google Sign-In -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --bg:#071025;
      --card:#0b1220;
      --accent:#6ee7b7;
      --text:#e6eef8;
      --muted:rgba(230,238,248,0.7);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Arial;direction:rtl;background:linear-gradient(180deg,var(--bg),#0f1720);color:var(--text)}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:rgba(255,255,255,0.02);backdrop-filter:blur(6px);position:sticky;top:0;z-index:50}
    .brand{font-weight:800;font-size:1.05rem}
    nav{display:flex;align-items:center;gap:14px}
    nav a{color:var(--text);text-decoration:none}
    nav a:hover{color:var(--accent)}
    .dropdown{position:relative}
    .dropdown-content{display:none;position:absolute;right:0;top:100%;background:var(--card);padding:6px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.5)}
    .dropdown:hover .dropdown-content{display:block}
    .dropdown-content a{display:block;padding:8px 12px;color:var(--text);text-decoration:none}
    .container{max-width:1000px;margin:24px auto;padding:0 16px}
    h1,h2,h3{margin:0}
    .hero{padding:30px 0;text-align:center}
    .product-grid{display:flex;flex-wrap:wrap;gap:18px;justify-content:center;margin-top:18px}
    .product-card{width:260px;background:rgba(255,255,255,0.03);border-radius:12px;padding:12px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
    .product-card img{width:100%;height:150px;object-fit:cover;border-radius:8px}
    .skin-card img{height:320px;object-fit:contain;background:#0a1220;border-radius:8px;padding:6px}
    .btn{display:inline-block;padding:8px 14px;border-radius:10px;background:var(--accent);color:#00221a;font-weight:700;text-decoration:none;margin-top:8px}
    .btn.view{background:#3da6d6;color:#fff}
    #contact.card{background:rgba(255,255,255,0.04);border-radius:16px;padding:20px;max-width:420px;margin:40px auto;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
    /* profile */
    .auth-area{display:flex;align-items:center;gap:8px}
    #user-profile{display:none;align-items:center;gap:8px;position:relative}
    #user-profile img{width:36px;height:36px;border-radius:50%;cursor:pointer;border:2px solid rgba(255,255,255,0.08)}
    #logout-menu{display:none;position:absolute;top:44px;left:0;background:var(--card);padding:8px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.5)}
    #logout-menu div{padding:6px 10px;cursor:pointer}
    #logout-menu div:hover{background:rgba(255,255,255,0.03)}

    /* responsive */
    @media (max-width:720px){
      .product-card{width:46%}
      .skin-card img{height:220px}
    }
    @media (max-width:420px){
      .product-card{width:100%}
    }

    /* ========== Gemini Chat Widget styles ========== */
    .chat-toggle{position:fixed;right:18px;bottom:20px;z-index:1200;background:var(--accent);color:#00221a;border:none;padding:12px 16px;border-radius:999px;box-shadow:0 10px 30px rgba(0,0,0,0.5);font-weight:800;cursor:pointer;display:flex;align-items:center;gap:10px}
    .chat-panel{position:fixed;right:18px;bottom:80px;width:360px;max-width:92vw;height:520px;max-height:82vh;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.6);display:flex;flex-direction:column;overflow:hidden;z-index:1200;border:1px solid rgba(255,255,255,0.03)}
    .chat-header{padding:12px 12px;border-bottom:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center}
    .chat-body{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .chat-footer{padding:10px;border-top:1px solid rgba(255,255,255,0.02);display:flex;gap:8px;background:linear-gradient(180deg,rgba(0,0,0,0.01),transparent)}
    .chat-footer input{flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.02);color:var(--text);outline:none}
    .chat-footer button{background:var(--accent);border:none;padding:10px 12px;border-radius:10px;color:#00221a;font-weight:800;cursor:pointer}
    .msg{max-width:78%;padding:10px 12px;border-radius:10px;line-height:1.3}
    .msg.user{align-self:flex-end;background:linear-gradient(90deg,var(--accent),#4fd6a6);color:#00221a;border-bottom-right-radius:4px}
    .msg.bot{align-self:flex-start;background:rgba(255,255,255,0.03);color:var(--text);border-bottom-left-radius:4px}
    .typing{font-style:italic;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="brand">STORM MARKET ✨</div>

    <nav>
      <a href="#home">خانه</a>
      <div class="dropdown">
        <a>محصولات ▾</a>
        <div class="dropdown-content">
          <a id="btn-packs">🎨 ریسورس‌پک‌ها</a>
          <a id="btn-skins">👕 اسکین‌ها</a>
        </div>
      </div>
      <a href="#contact">تماس با ما</a>
    </nav>

    <div class="auth-area" aria-hidden="false">
      <!-- Google Sign-In loader -->
      <div id="g_id_onload"
           data-client_id="880081159110-stcmf4n7s6b9tt13s8kvjgldhqcuott0.apps.googleusercontent.com"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false">
      </div>

      <div class="g_id_signin"
           data-type="standard"
           data-shape="pill"
           data-theme="outline"
           data-text="signin_with"
           data-size="medium">
      </div>

      <!-- profile UI -->
      <div id="user-profile" aria-live="polite">
        <img id="user-pic" src="" alt="تصویر کاربر">
        <div id="user-name"></div>
        <div id="logout-menu"><div id="logout-btn">خروج</div></div>
      </div>
    </div>
  </header>

  <main class="container" id="main">
    <section id="home" class="hero">
      <h1>به استورم مارکت خوش آمدی ⚡</h1>
      <p class="small" style="color:var(--muted);margin-top:8px">ریسورس‌پک‌ها، اسکین‌ها و مودهای منتخب برای ماینکرافت</p>
    </section>

    <section id="packs-section">
      <h2>🎨 ریسورس‌پک‌ها</h2>
      <div class="product-grid" id="packs-grid">
        <div class="product-card">
          <img src="resources/texturepack1.png" alt="ریسورس پک استورم">
          <h4>ریسورسپک استورم ⚡</h4>
          <div style="margin-top:10px">
            <a href="resources/§BSTORM PACK §f[§616x§f].zip" download class="btn">دانلود</a>
            <a href="pack1.html" class="btn view">مشاهده بیشتر</a>
          </div>
        </div>

        <div class="product-card">
          <img src="resources/texturepack2.png" alt="WinStone">
          <h4>ریسورپک بدوارز WinStone 💎</h4>
          <div style="margin-top:10px">
            <a href="resources/Winstone_16x16.zip" download class="btn">دانلود</a>
            <a href="pack2.html" class="btn view">مشاهده بیشتر</a>
          </div>
        </div>

        <div class="product-card">
          <img src="resources/texturepack3.png" alt="Christmas Pack">
          <h4>ریسورسپک کریسمس 🎅</h4>
          <div style="margin-top:10px">
            <a href="resources/ChristmasPack_1.20.1.zip" download class="btn">دانلود</a>
            <a href="pack3.html" class="btn view">مشاهده بیشتر</a>
          </div>
        </div>
      </div>
    </section>

    <section id="skins-section" style="display:none">
      <h2>👕 اسکین‌ها</h2>
      <div class="product-grid">
        <div class="product-card skin-card">
          <img src="skin/preview_skin1.png" alt="اسکین 1">
          <h4>اسکین شماره ۱</h4>
          <a href="skin/skin1.png" download class="btn">دانلود</a>
        </div>
        <div class="product-card skin-card">
          <img src="skin/preview_skin2.png" alt="اسکین 2">
          <h4>اسکین شماره ۲</h4>
          <a href="skin/skin2.png" download class="btn">دانلود</a>
        </div>
        <div class="product-card skin-card">
          <img src="skin/preview_skin3.png" alt="اسکین 3">
          <h4>اسکین شماره ۳</h4>
          <a href="skin/skin3.png" download class="btn">دانلود</a>
        </div>
      </div>
    </section>

    <section id="contact" class="card">
      <h3>تماس با ما</h3>
      <p>📧 vestarsite@gmail.com</p>
      <p>📱 Discord: stormy.noob</p>
    </section>
  </main>

  <!-- Gemini Chat widget -->
  <button id="chatToggle" class="chat-toggle" aria-expanded="false">💬 چت با Gemini</button>

  <div id="chatPanel" class="chat-panel" style="display:none" role="dialog" aria-label="چت با Gemini">
    <div class="chat-header">
      <div>
        <strong>Gemini (تست)</strong>
        <div style="font-size:0.85rem;color:var(--muted)">فارسی و انگلیسی پشتیبانی می‌شود</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="chatClose" style="background:transparent;border:none;color:var(--muted);cursor:pointer">✕</button>
      </div>
    </div>

    <div id="chatBody" class="chat-body" aria-live="polite">
      <div class="msg bot">سلام! من چت‌بات آزمایشی Gemini هستم. هر سؤال داری بپرس :)</div>
    </div>

    <div class="chat-footer">
      <input id="chatInput" placeholder="سؤالتو بنویس..." aria-label="متن پیام">
      <button id="sendBtn">ارسال</button>
    </div>
  </div>

  <script>
    /********************************************************
     *  تنظیمات مهم:
     *  اگر URL سرورت فرق داره همین متغیر رو تغییر بده.
     *  (کلید API نباید در این فایل باشه؛ روی Render ذخیره شده)
     ********************************************************/
    const GEMINI_ENDPOINT = 'https://mcstormmarket-1.onrender.com/api/gemini';

    // ========== Nav toggle packs/skins ==========
    const packsSection = document.getElementById('packs-section');
    const skinsSection = document.getElementById('skins-section');
    document.getElementById('btn-packs').addEventListener('click', () => {
      packsSection.style.display = 'block';
      skinsSection.style.display = 'none';
      window.scrollTo({top: packsSection.offsetTop - 20, behavior: 'smooth'});
    });
    document.getElementById('btn-skins').addEventListener('click', () => {
      packsSection.style.display = 'none';
      skinsSection.style.display = 'block';
      window.scrollTo({top: skinsSection.offsetTop - 20, behavior: 'smooth'});
    });

    // ========== Google Sign-in handlers ==========
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        return {};
      }
    }

    function handleCredentialResponse(response) {
      const data = parseJwt(response.credential);
      const user = { name: data.name || data.email, picture: data.picture || '', email: data.email || '' };
      localStorage.setItem('gm_user', JSON.stringify(user));
      showProfile(user);
    }

    function showProfile(user) {
      document.querySelector('.g_id_signin').style.display = 'none';
      const up = document.getElementById('user-profile');
      document.getElementById('user-pic').src = user.picture || 'favicon.png';
      document.getElementById('user-name').textContent = user.name || user.email;
      up.style.display = 'flex';
    }

    // logout
    const userPic = document.getElementById('user-pic');
    const logoutMenu = document.getElementById('logout-menu');
    const logoutBtn = document.getElementById('logout-btn');

    userPic?.addEventListener('click', (e) => {
      logoutMenu.style.display = logoutMenu.style.display === 'block' ? 'none' : 'block';
      e.stopPropagation();
    });

    logoutBtn?.addEventListener('click', () => {
      if(window.google?.accounts?.id) window.google.accounts.id.disableAutoSelect();
      localStorage.removeItem('gm_user');
      document.getElementById('user-profile').style.display = 'none';
      document.querySelector('.g_id_signin').style.display = 'inline-block';
      logoutMenu.style.display = 'none';
      alert('با موفقیت خارج شدی 👋');
    });

    document.addEventListener('click', e => {
      const up = document.getElementById('user-profile');
      if(up && !up.contains(e.target)) logoutMenu.style.display = 'none';
    });

    const saved = localStorage.getItem('gm_user');
    if (saved) showProfile(JSON.parse(saved));

    // ========== Gemini Chat ==========
    const chatToggle = document.getElementById('chatToggle');
    const chatPanel = document.getElementById('chatPanel');
    const chatClose = document.getElementById('chatClose');
    const chatBody = document.getElementById('chatBody');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');

    function appendMessage(text, who='bot') {
      const el = document.createElement('div');
      el.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
      el.textContent = text;
      chatBody.appendChild(el);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function setTyping(on) {
      if (on) {
        const t = document.createElement('div');
        t.className = 'msg bot typing';
        t.id = 'typingIndicator';
        t.textContent = 'در حال نوشتن...';
        chatBody.appendChild(t);
        chatBody.scrollTop = chatBody.scrollHeight;
      } else {
        const t = document.getElementById('typingIndicator');
        if (t) t.remove();
      }
    }

    chatToggle.addEventListener('click', () => {
      const open = chatPanel.style.display !== 'none';
      chatPanel.style.display = open ? 'none' : 'flex';
      chatToggle.setAttribute('aria-expanded', (!open).toString());
      if(!open) setTimeout(()=> chatInput.focus(), 120);
    });

    chatClose.addEventListener('click', () => {
      chatPanel.style.display = 'none';
      chatToggle.setAttribute('aria-expanded', 'false');
    });

    async function sendPrompt(prompt) {
      prompt = (prompt || '').trim();
      if (!prompt) return;
      appendMessage(prompt, 'user');
      chatInput.value = '';
      setTyping(true);

      try {
        const res = await fetch(GEMINI_ENDPOINT, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ prompt })
        });

        if (!res.ok) {
          const txt = await res.text().catch(()=>res.status);
          throw new Error('خطا از سرور: ' + txt);
        }

        const data = await res.json();
        setTyping(false);

        if (data && data.reply) {
          appendMessage(data.reply, 'bot');
        } else {
          appendMessage('پاسخی دریافت نشد یا فرمت پاسخ غیرمنتظره بود.', 'bot');
        }
      } catch (err) {
        setTyping(false);
        appendMessage('خطا: ' + (err.message || err), 'bot');
        console.error(err);
      }
    }

    sendBtn.addEventListener('click', () => sendPrompt(chatInput.value));
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // handy: allow quick demo prompt by typing "/demo"
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && chatInput.value.trim() === '/demo') {
        e.preventDefault();
        sendPrompt('سلام! توضیح بده ریسورسپک استورم چیه و چطور نصب می‌شود.');
      }
    });

    // accessibility: focus chat with ctrl+k
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault();
        if (chatPanel.style.display === 'none') chatToggle.click();
        chatInput.focus();
      }
    });

    // small auto-welcome after open
    chatToggle.addEventListener('click', () => {
      if (!localStorage.getItem('gemini_welcomed')) {
        setTimeout(()=> appendMessage('برای تست می‌تونی بنویسی: "سلام" یا "این پک چی دارد؟"', 'bot'), 600);
        localStorage.setItem('gemini_welcomed', '1');
      }
    });

  </script>
</body>
</html>
